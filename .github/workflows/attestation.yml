name: Release & Attestation

on:
  push:
    tags:
      - '**' 

jobs:
  create-release:
    runs-on: windows-latest
    permissions:
      id-token: write
      contents: write
      attestations: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # - name: Update Inno Setup Version
      #   shell: pwsh
      #   run: |
      #     $version = "${{ github.ref_name }}"
      #     Write-Host "Updating .iss AppVersion to: $version"
      #     (Get-Content setup_script.iss) -replace 'AppVersion=.*', "AppVersion=$version" | Set-Content setup_script.iss

      # Using built-in ISCC compiler
      - name: Compile Inno Setup
        shell: pwsh
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup_script.iss

      - name: Generate Build Provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: 'KiwiMS-Windows-x86_64.exe'

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: 'KiwiMS-Windows-x86_64.exe'
          body: ${{ steps.calc_hash.outputs.hash_note }}
          append_body: true 
          draft: false
          prerelease: false

      - name: Email Success Notification
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "üöÄ KiwiMS Release Successful: ${{ github.ref_name }}"
          to: marian.freisleben@liora-bioinformatics.com
          from: GitHub Actions
          body: |
            KiwiMS version ${{ github.ref_name }} has been built and released.
            
            Link to Release:
            https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}

      - name: Email Failure Notification
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ùå FAILED: KiwiMS Release Build (${{ github.ref_name }})"
          to: marian.freisleben@liora-bioinformatics.com
          from: GitHub Actions
          body: |
            The build for tag '${{ github.ref_name }}' failed. 
            
            Check the logs:
            https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
