name: Test Windows Installer

on: workflow_dispatch

jobs:
  test-installer:
    runs-on: windows-2022
    
    strategy:
      matrix:
        install-mode: [ALLUSERS, CURRENTUSER]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Compile Inno Setup to EXE
        run: iscc setup_script.iss
        
      - name: Run Installer Silently
        run: |
          $modeFlag = if ("${{ matrix.install-mode }}" -eq "ALLUSERS") { "/ALLUSERS" } else { "/CURRENTUSER" }
          $proc = Start-Process -FilePath ".\KiwiMS_0.3.1-Windows-x86_64.exe" `
              -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "$modeFlag", "/LOG=innosetup.log" `
              -PassThru -Wait
          
          Write-Host "Installer finished with Exit Code: $($proc.ExitCode)"
          
          if ($proc.ExitCode -ne 0) {
            Get-Content innosetup.log
            exit $proc.ExitCode
          }
          
      - name: Print Installation Logs on Failure
        if: always()
        run: |
          $logPath = "$env:LOCALAPPDATA\KiwiMS\kiwims_setup.log"
          if (Test-Path $logPath) {
              Get-Content $logPath
          } else {
              Write-Host "Internal log not found at $logPath"
          }

      - name: Check Built-in Inno Setup Log for Errors
        run: |
          Get-Content innosetup.log | Select-String -Pattern "error|failed|exception" -Context 5

      - name: Launch test KiwiMS
        run: |
          $appDir = if ("${{ matrix.install-mode }}" -eq "ALLUSERS") { "C:\Program Files\KiwiMS" } else { "$env:LOCALAPPDATA\KiwiMS" }
          $exePath = Join-Path $appDir "KiwiMS.exe"
      
          Write-Host "Searching for executable at: $exePath"
          if (-not (Test-Path $exePath)) { Write-Error "Executable not found!"; exit 1 }
      
          # Start the app
          $process = Start-Process -FilePath $exePath -WorkingDirectory $appDir -PassThru
      
          Write-Host "App launched. Waiting 30 seconds for Conda and Shiny to initialize..."
          Start-Sleep -Seconds 30
      
          # Check if the process died 
          if ($process.HasExited) {
              Write-Host "App exited prematurely with code $($process.ExitCode)"
              Get-Content "$env:LOCALAPPDATA\KiwiMS\launch.log" -ErrorAction SilentlyContinue
              exit 1
          }
      
          # Verify the Shiny Port is active
          Write-Host "Checking for Shiny server on port 3838..."
          $portCheck = Test-NetConnection -ComputerName localhost -Port 3838 -WarningAction SilentlyContinue
          
          if ($portCheck.TcpTestSucceeded) {
              Write-Host "SUCCESS: Shiny server is responding on port 3838!"
              Stop-Process -Id $process.Id -Force
          } else {
              Write-Host "FAILURE: Port 3838 not responding. Checking launch.log..."
              Get-Content "$env:LOCALAPPDATA\KiwiMS\launch.log" -ErrorAction SilentlyContinue
              Stop-Process -Id $process.Id -Force
              exit 1
          }

      - name: Upload Logs (Always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: install-logs-${{ matrix.install-mode }}
          path: |
            innosetup.log
            C:\Users\runneradmin\AppData\Local\KiwiFlow\kiwims_setup.log
