name: Test Windows Installer

on: workflow_dispatch

jobs:
  test-installer:
    runs-on: windows-2022
    
    strategy:
      matrix:
        install-mode: [ALLUSERS, CURRENTUSER]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Compile Inno Setup to EXE
        run: iscc setup_script.iss
  
      - name: Run Installer Silently (${{ matrix.install-mode }})
        run: |
          $mode = if ("${{ matrix.install-mode }}" -eq "ALLUSERS") { "/ALLUSERS" } else { "/CURRENTUSER" }
          .\KiwiMS_0.3.1-Windows-x86_64.exe /VERYSILENT /SUPPRESSMSGBOXES /NORESTART $mode /LOG="innosetup.log"
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Installer failed with exit code $LASTEXITCODE"
            Get-Content innosetup.log | Select-String -Pattern "error|failed|exception"
            exit $LASTEXITCODE
          }

      - name: Print Installation Logs on Failure
        if: always()
        run: |
          $logPath = "$env:LOCALAPPDATA\KiwiMS\kiwims_setup.log"
          if (Test-Path $logPath) {
              Get-Content $logPath
          } else {
              Write-Host "Internal log not found at $logPath"
          }

      - name: Check Built-in Inno Setup Log for Errors
        run: |
          Get-Content innosetup.log | Select-String -Pattern "error|failed|exception" -Context 5

      - name: Upload Logs (Always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: install-logs-${{ matrix.install-mode }}
          path: |
            innosetup.log
            C:\Users\runneradmin\AppData\Local\KiwiFlow\kiwiflow_setup.log
