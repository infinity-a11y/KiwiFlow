name: KiwiMS Weekly Validation

on:
  workflow_dispatch: # Allows manual trigger
  schedule:
    - cron: '0 8 * * 1' # Every Monday at 08:00 UTC

jobs:
  test-installer:
    strategy:
      fail-fast: false # Run all tests even if one fails
      matrix:
        os: [windows-2019, windows-latest]
        install-mode: [ALLUSERS, CURRENTUSER]

    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Compile Inno Setup to EXE
        run: iscc setup_script.iss
        
      - name: Run Installer Silently
        run: |
          $modeFlag = if ("${{ matrix.install-mode }}" -eq "ALLUSERS") { "/ALLUSERS" } else { "/CURRENTUSER" }
          $proc = Start-Process -FilePath ".\KiwiMS_0.3.1-Windows-x86_64.exe" `
              -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "$modeFlag", "/LOG=innosetup.log" `
              -PassThru -Wait
          
          if ($proc.ExitCode -ne 0) {
            Write-Host "Installer failed with code: $($proc.ExitCode)"
            Get-Content innosetup.log | Select-String -Pattern "error|failed|exception"
            exit $proc.ExitCode
          }
          
      - name: Launch Smoke Test
        run: |
          # Determine path based on matrix mode
          $appDir = if ("${{ matrix.install-mode }}" -eq "ALLUSERS") { "${{ env.ProgramFiles }}\KiwiMS" } else { "$env:LOCALAPPDATA\KiwiMS" }
          $exePath = Join-Path $appDir "KiwiMS.exe"
      
          Write-Host "Testing app on ${{ matrix.os }} at $exePath"
          $process = Start-Process -FilePath $exePath -WorkingDirectory $appDir -PassThru
      
          Start-Sleep -Seconds 30 # Wait for Conda & Shiny
      
          if ($process.HasExited) {
              Write-Error "App crashed on ${{ matrix.os }}!"
              Get-Content "$env:LOCALAPPDATA\KiwiMS\launch.log" -ErrorAction SilentlyContinue
              exit 1
          }
      
          # Port check (Ensures the R backend actually started)
          $portCheck = Test-NetConnection -ComputerName localhost -Port 3838 -WarningAction SilentlyContinue
          Stop-Process -Id $process.Id -Force
          
          if (-not $portCheck.TcpTestSucceeded) {
              Write-Error "Shiny port 3838 not responding!"
              exit 1
          }

      - name: Upload Artifacts (Logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.os }}-${{ matrix.install-mode }}
          path: |
            innosetup.log
            $env:LOCALAPPDATA\KiwiMS\kiwims_setup.log
            $env:LOCALAPPDATA\KiwiMS\launch.log
