name: Weekly Validation

on:
  workflow_dispatch:
  schedule:
    - cron: '0 5 * * 1'

jobs:
  test-installer:
    strategy:
      fail-fast: false
      matrix:
        os: [windows-2019, windows-2022, windows-latest]
        install-mode: [ALLUSERS, CURRENTUSER]

    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Compile Inno Setup to EXE
        run: iscc setup_script.iss
        
      - name: Run Installer Silently
        shell: pwsh
        run: |
          # Run installer
          $modeFlag = if ("${{ matrix.install-mode }}" -eq "ALLUSERS") { "/ALLUSERS" } else { "/CURRENTUSER" }
          $proc = Start-Process -FilePath ".\KiwiMS-Windows-x86_64.exe" `
              -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "$modeFlag", "/LOG=innosetup.log" `
              -PassThru -Wait
          
          # Check C: drive and copy it to the current folder (D: drive)
          $cDriveLog = "C:\Users\runneradmin\AppData\Local\KiwiMS\kiwims_setup.log"
          if (Test-Path $cDriveLog) {
              Copy-Item -Path $cDriveLog -Destination ".\kiwims_setup.log" -Force
              Write-Host "Log harvested from C: drive and moved to workspace."
          } else {
              Write-Warning "Could not find log at $cDriveLog"
          }

          # Handle exit codes 
          if ($proc.ExitCode -ne 0) { exit $proc.ExitCode }

      - name: Upload Artifacts (Logs)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.os }}-${{ matrix.install-mode }}
          path: |
            innosetup.log
            kiwims_setup.log
